### 简介

- 因为内存的易失性。一般情况下，我们都会选择将表中的数据和索引存储在磁盘这种外围设备中。
- 和内存相比，从磁盘中读取数据的速度会慢上百倍千倍甚至万倍，所以，我们应当尽量减少从磁盘中读取数据的次数。 另外，从磁盘中读取数据时，操作系统都是按照磁盘块来读取的，并不是一条一条的读。
- 如果我们能把尽量多的数据放进磁盘块中，那一次磁盘读取操作就会读取更多数据，那我们查找数据的时间也会大幅度降低。

### 什么是B树

> 提到 B+树，就不得不提到 B 树，我们先开看下图中的B树。

![B树](https://gitee.com/ssezhangpeng/picture/raw/master/MySQL/20220208231024.png)

- 图中的p节点为指向子节点的指针，图中的每个节点称为页，页就是我们上面说的磁盘块，在mysql中数据读取的基本单位都是页，所以我们这里叫做页更符合mysql中索引的底层数据结构。
- 从上图可以看出，B树相对于平衡二叉树，每个节点存储了更多的键值(key)和数据(data)，并且每个节点拥有更多的子节点，子节点的个数一般称为阶，上述图中的B树为3阶B树，高度也会很低。 基于这个特性，B树查找数据读取磁盘的次数将会很少，数据的查找效率也会比平衡二叉树高很多。
- 由于b树所有的节点都可能包含目标数据，总是要从根节点向下遍历子树查找满足条件的数据行，这个特点带来了大量的随机 I/O，也是b树最大的性能问题.。

### 什么是B+树

> B+树是对B树的进一步优化，我们先开看下图中的B+树。它和B树有哪些不同呢？

<img src="https://gitee.com/ssezhangpeng/picture/raw/master/MySQL/20220208230454.png" alt="B+树"  />

- B+树非叶子节点上是不存储数据的，仅存储键值，而B树节点中不仅存储键值，也会存储数据。之所以这么做是因为在数据库中页的大小是固定的，innodb中页的默认大小是16KB。如果不存储数据，那么就会存储更多的键值，相应的树的阶数（节点的子节点树）就会更大，树就会更矮更胖，如此一来我们查找数据进行磁盘的IO次数有会再次减少，数据查询的效率也会更快。另外，B+树的阶数是等于键值的数量的，如果我们的B+树一个节点可以存储1000个键值，那么3层B+树可以存储1000×1000×1000=10亿个数据。一般根节点是常驻内存的，所以一般我们查找10亿数据，只需要2次磁盘IO。
- 因为B+树索引的所有数据均存储在叶子节点，而且数据是按照顺序排列的。那么B+树使得范围查找，排序查找，分组查找以及去重查找变得异常简单。而B树因为数据分散在各个节点，要实现这一点是很不容易的。
- B+树中各个页之间是通过双向链表连接的，叶子节点中的数据是通过单向链表连接的。我们通过数据页之间通过双向链表连接以及叶子节点中数据之间通过单向链表连接的方式可以找到表中所有的数据。

### 总结

- B+树非叶子结点只存键值，不存数据，每页可以存放更多索引数据，相应的阶就会更大，IO次数就会更小。
- B+树数据都存放在叶子结点，并且每个叶有双向指针相连，可以方便的进行范围查询等操作，顺序IO强于随机IO。并且查询效率稳定。

- 相邻的数据在同一个页内，根据局部性原理，可以充分利用操作系统的预读。

### 扩展

- 为什么不用二叉树(BST, AVL, RBTREE)？
  - 以上都是二叉树，当数据量非常大时，树高度会很高, 造成磁盘io扫描次数很高。
  - 一个节点只是存放一个数据, 数据与数据之间在物理内存相隔甚远, 磁盘扫描需要频繁转动。
  - 需要频繁的从磁盘读数据到内存中, 即使操作系统有预读, 但是带出来的大多是暂时用不上的无用数据, 造成浪费。
- 为什么不用Hash表？
  - hash 只能用于等值的查询，不能用于范围查询。
  - hash 不能用来进行排序操作。
  - Hash 索引不能利用部分索引键查询。对于组合索引，Hash 索引在计算 Hash 值的时候是组合索引键合并后再一起计算 Hash 值，而不是单独计算 Hash 值，所以通过组合索引的前面一个或几个索引键进行查询的时候，Hash 索引也无法被利用。
  - Hash 索引在任何时候都不能避免表扫描。Hash 索引是将索引键通过 Hash 运算之后，将 Hash运算结果的 Hash 值和所对应的行指针信息存放于一个 Hash 表中，由于不同索引键存在相同 Hash 值，所以即使取满足某个 Hash 键值的数据的记录条数，也无法从 Hash 索引中直接完成查询，还是要通过访问表中的实际数据进行相应的比较，并得到相应的结果。
- 为什么不用 skipList?
  - skipList 每个结点只能存一个键值对，数据量大的时候会造成深度过大，磁盘IO较多。只适合内存数据搜索。